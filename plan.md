# NuRaft å¼€å‘è®¡åˆ’

æœ¬æ–‡æ¡£è®°å½• NuRaft é¡¹ç›®çš„é‡è¦å¼€å‘ä»»åŠ¡ã€è®¾è®¡æ–¹æ¡ˆå’Œå®ç°ç»†èŠ‚ã€‚

---

## å½“å‰ä»»åŠ¡

### ç«¯å£å¤ç”¨åŠŸèƒ½å¼€å‘

**ç›®æ ‡**ï¼šè®©å¤šä¸ª Raft group å…±äº«åŒä¸€ä¸ª TCP ç«¯å£ï¼Œè§£å†³ç«¯å£èµ„æºæ¶ˆè€—é—®é¢˜ã€‚

**çŠ¶æ€**ï¼šâœ… é˜¶æ®µ 1 å®Œæˆï¼Œâœ… é˜¶æ®µ 2 å®Œæˆ

**å¼€å‘åˆ†æ”¯**ï¼š`feature/port-sharing`

**è¯¦ç»†è®¾è®¡æ–‡æ¡£**ï¼š[docs/port-sharing-design.md](docs/port-sharing-design.md)

**è®¾è®¡æ–¹æ¡ˆæ‘˜è¦**ï¼š
- é‡‡ç”¨æ–¹æ¡ˆ Aï¼šæ‰©å±•æ¶ˆæ¯å¤´éƒ¨ + Dispatcher æ¶æ„
- åœ¨ RPC æ¶ˆæ¯å¤´éƒ¨æ·»åŠ  `group_id` å­—æ®µï¼ˆ39 â†’ 43 å­—èŠ‚ï¼‰
- åˆ›å»º `raft_group_dispatcher` ç®¡ç†å¤šä¸ª Raft group çš„è·¯ç”±
- ä¿®æ”¹ `asio_rpc_session` æ”¯æŒ group_id è§£æå’Œåˆ†å‘
- ä¿æŒå‘åå…¼å®¹æ€§ï¼ˆflags å­—æ®µæ ‡è¯†æ‰©å±•æ ¼å¼ï¼‰

**æ ¸å¿ƒæ¶æ„**ï¼š
```
1 port = 1 asio_listener = N raft_servers (group_id è·¯ç”±)
```

---

## é˜¶æ®µ 1 å®Œæˆæƒ…å†µ âœ…

**å®Œæˆæ—¶é—´**ï¼š2025-01-21

**æäº¤**ï¼ša8c26e6 "Add port sharing infrastructure (Phase 1)"

### å·²å®Œæˆçš„å·¥ä½œ

1. **raft_group_dispatcher ç±»** âœ…
   - å¤´æ–‡ä»¶ï¼š`include/libnuraft/raft_group_dispatcher.hxx`
   - å®ç°ï¼š`src/raft_group_dispatcher.cxx`
   - åŠŸèƒ½ï¼š
     - æ³¨å†Œ/æ³¨é”€ Raft groups
     - æ ¹æ® group_id è·¯ç”±è¯·æ±‚
     - çº¿ç¨‹å®‰å…¨ï¼ˆmutex ä¿æŠ¤ï¼‰
     - æ´»åŠ¨æ—¶é—´è·Ÿè¸ª

2. **æ¶ˆæ¯æ ¼å¼æ‰©å±•** âœ…
   - `req_msg` æ·»åŠ  `group_id_` å­—æ®µ
   - `resp_msg` æ·»åŠ  `group_id_` å­—æ®µ
   - å‘åå…¼å®¹ï¼ˆé»˜è®¤å€¼ 0ï¼‰
   - æ‰©å±•æ ¼å¼å¸¸é‡ï¼š
     - `RPC_REQ_HEADER_EXT_SIZE` = 43
     - `RPC_RESP_HEADER_EXT_SIZE` = 43
     - `FLAG_EXTENDED_HEADER` = 0x80

3. **å•å…ƒæµ‹è¯•** âœ…
   - æµ‹è¯•æ–‡ä»¶ï¼š`tests/unit/dispatcher_test.cxx`
   - ç¼–è¯‘é€šè¿‡
   - æµ‹è¯•é€šè¿‡ï¼š1/1
   - æ‰§è¡Œæ—¶é—´ï¼š44 å¾®ç§’

4. **ä»£ç é›†æˆ** âœ…
   - dispatcher å£°æ˜ä¸º `raft_server` çš„ friend ç±»
   - CMakeLists.txt é…ç½®å®Œæˆ
   - æˆåŠŸç¼–è¯‘å’Œè¿è¡Œ

---

## é˜¶æ®µ 2 å®Œæˆæƒ…å†µ âœ…

**å®Œæˆæ—¶é—´**ï¼š2025-01-21

**æäº¤è®°å½•**ï¼š
- 2adfabc "Modify message parsing to support extended header format"
- a9507f7 "Add message serialization support for extended header format"
- <commit-hash> "Integrate dispatcher into RPC layer for port sharing (Phase 2 - Part 3)"
- c5a390b "Add shared port API to raft_launcher (Phase 2 - Part 4)"

### å·²å®Œæˆçš„å·¥ä½œ

1. **æ¶ˆæ¯å¤´éƒ¨è§£æ** âœ…
   - æ£€æµ‹ FLAG_EXTENDED_HEADER æ ‡å¿—
   - åŠ¨æ€ç¡®å®šå¤´éƒ¨å¤§å°ï¼ˆ39 vs 43 å­—èŠ‚ï¼‰
   - è§£æ group_id å­—æ®µ
   - å‘åå…¼å®¹ï¼ˆé»˜è®¤ group_id = 0ï¼‰

2. **æ¶ˆæ¯åºåˆ—åŒ–** âœ…
   - å‘é€è¯·æ±‚æ—¶æ£€æµ‹ group_id
   - ä½¿ç”¨æ‰©å±•æ ¼å¼ï¼ˆ43 å­—èŠ‚ï¼‰å½“ group_id != 0
   - æ­£ç¡®è®¾ç½® FLAG_EXTENDED_HEADER
   - è°ƒæ•´ç¼“å†²åŒºå¤§å°å’Œ CRC è®¡ç®—

3. **å“åº”åºåˆ—åŒ–/ååºåˆ—åŒ–** âœ…
   - å‘é€å“åº”æ—¶åŒ…å« group_id
   - æ¥æ”¶å“åº”æ—¶è§£æ group_id
   - æ·»åŠ  padding å­—èŠ‚ä¿æŒå¯¹é½
   - åŠ¨æ€å¤´éƒ¨å¤§å°å¤„ç†

4. **RPC å±‚é›†æˆ** âœ…
   - rpc_session é›†æˆ dispatcher
   - æ ¹æ® group_id è·¯ç”±è¯·æ±‚
   - é”™è¯¯å¤„ç†ï¼ˆgroup ä¸å­˜åœ¨æ—¶è¿”å› nullï¼‰

5. **asio_rpc_listener ä¿®æ”¹** âœ…
   - æ·»åŠ  dispatcher_ æˆå‘˜
   - å®ç° set_dispatcher() æ–¹æ³•
   - åˆ›å»º session æ—¶ä¼ é€’ dispatcher

6. **raft_launcher API** âœ…
   - init_shared_port() - åˆå§‹åŒ–å…±äº«ç«¯å£æ¨¡å¼
   - add_group() - æ·»åŠ  Raft group
   - remove_group() - ç§»é™¤ Raft group
   - get_server() - è·å–æŒ‡å®š group çš„ server
   - æ”¯æŒä¼ ç»Ÿæ¨¡å¼å’Œå…±äº«ç«¯å£æ¨¡å¼

7. **å•å…ƒæµ‹è¯•** âœ…
   - dispatcher_test: 1/1 é€šè¿‡
   - launcher_test: 6/6 é€šè¿‡

---

## é˜¶æ®µ 3 å¾…å®Œæˆ ğŸ”„

**é¢„è®¡å·¥ä½œé‡**ï¼š2-3 å¤©

### å¾…å®Œæˆçš„ä»»åŠ¡

1. **é›†æˆæµ‹è¯•**
   - [ ] å¤š group å…±äº«ç«¯å£æµ‹è¯•ï¼ˆçœŸå®é€šä¿¡ï¼‰
   - [ ] åŠ¨æ€æ·»åŠ /åˆ é™¤ group æµ‹è¯•
   - [ ] å¹¶å‘å‹åŠ›æµ‹è¯•ï¼ˆ10 groups Ã— 100 messagesï¼‰
   - [ ] æ€§èƒ½æµ‹è¯•ï¼ˆååé‡ã€å»¶è¿Ÿï¼‰
   - [ ] å…¼å®¹æ€§æµ‹è¯•ï¼ˆæ–° â†” æ—§ç‰ˆæœ¬ï¼‰

2. **æ–‡æ¡£å®Œå–„**
   - [ ] API ä½¿ç”¨æ–‡æ¡£
   - [ ] è¿ç§»æŒ‡å—
   - [ ] ç¤ºä¾‹ä»£ç 

---

## å†å²ä»»åŠ¡

---

## å†å²ä»»åŠ¡

ï¼ˆæš‚æ— ï¼‰

---

## ç›¸å…³èµ„æº

- **å¼€å‘è§„åˆ™**ï¼šå‚è§ [notes.md](notes.md)
- **é¡¹ç›®æ ¹ç›®å½•**ï¼š/home/dodo/code/NuRaft
- **ä¸»è¦ä»£ç ç›®å½•**ï¼š
  - `include/libnuraft/` - å…¬å…±å¤´æ–‡ä»¶
  - `src/` - å®ç°ä»£ç 
  - `tests/` - æµ‹è¯•ä»£ç 
  - `examples/` - ç¤ºä¾‹ä»£ç 

---

## è®¾è®¡å†³ç­–è®°å½•

### 2025-01-21ï¼šé€‰æ‹©ç«¯å£å¤ç”¨æ–¹æ¡ˆ A

**å†³ç­–**ï¼šé‡‡ç”¨æ‰©å±•æ¶ˆæ¯å¤´éƒ¨ + Dispatcher æ¶æ„

**ç†ç”±**ï¼š
- è®¾è®¡æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦»
- æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€æ·»åŠ /åˆ é™¤ group
- å‘åå…¼å®¹ï¼ˆflags æ ‡è¯†æ–°ç‰ˆæœ¬ï¼‰
- æ€§èƒ½å½±å“æœ€å°ï¼ˆä»…å¢åŠ  4 å­—èŠ‚ï¼‰

**å‚è€ƒ**ï¼š[docs/port-sharing-design.md](docs/port-sharing-design.md)

---

## å¾…åŠäº‹é¡¹

- [ ] å®Œæˆç«¯å£å¤ç”¨åŠŸèƒ½çš„è®¾è®¡æ–¹æ¡ˆç¡®è®¤
- [ ] å¯¹é½æµ‹è¯•ç”¨ä¾‹
- [ ] å®ç° `raft_group_dispatcher` ç±»
- [ ] æ‰©å±•æ¶ˆæ¯å¤´éƒ¨å®šä¹‰
- [ ] ä¿®æ”¹ RPC å±‚ä»£ç 
- [ ] æ›´æ–° API
- [ ] ç¼–å†™æµ‹è¯•
- [ ] æ›´æ–°æ–‡æ¡£

---

*æœ€åæ›´æ–°ï¼š2025-01-21 - é˜¶æ®µ 2 å·²å®Œæˆ*
